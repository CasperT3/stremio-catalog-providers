<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Catalog Providers - Stremio Addon Configuration</title>
    <link rel="shortcut icon" href="https://your-icon-url.com/favicon.ico" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Helvetica:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Helvetica', sans-serif;
        line-height: 1.6;
        background: #f0f0f5;
        color: #333;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
        transition: background 0.3s, color 0.3s;
      }

      #addon {
        position: relative;
        width: 90%;
        max-width: none;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        margin: 0 auto;
      }

      .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.3s;
        z-index: 10;
      }

      body.dark-mode {
        background: #333;
        color: #f0f0f5;
      }

      body.dark-mode #addon {
        background: #444;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      }

      body.dark-mode .provider {
        background: #555;
        border-color: #666;
      }

      body.dark-mode .provider:hover {
        border-color: #f0f0f5;
        box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
      }

      body.dark-mode .link-display {
        background: #666;
        border: 1px solid #777;
      }

      body.dark-mode .name {
        color: #f0f0f5;
      }

      body.dark-mode .version {
        color: #aaa;
      }

      body.dark-mode .description {
        color: #ccc;
      }

      body.dark-mode .form-element label {
        color: #f0f0f5;
      }

      body.dark-mode .form-element input {
        background: #555;
        color: #f0f0f5;
        border: 1px solid #666;
      }

      body.dark-mode .form-element input::placeholder {
        color: #bbb;
      }

      body.dark-mode .providers-title,
      body.dark-mode .selected-providers-title {
        color: #f0f0f5;
      }

      .providers-title,
      .selected-providers-title {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 15px;
        font-weight: 600;
        text-align: left;
      }

      body.dark-mode .providers-title,
      body.dark-mode .selected-providers-title {
        color: #f0f0f5;
      }

      body.dark-mode .modal {
        background-color: #333;
        color: #f0f0f5;
        border: 1px solid #444;
      }

      body.dark-mode .modal-close {
        color: #f0f0f5;
      }

      body.dark-mode .modal h4 {
        color: #f0f0f5;
      }

      body.dark-mode .modal p,
      body.dark-mode .modal ul {
        color: #ccc;
      }

      body.dark-mode .modal ul li {
        color: #ccc;
      }

      body.dark-mode .form-element label {
        color: #e0e0e0;
        display: flex;
        align-items: center;
        font-size: 1rem;
      }

      body.dark-mode .form-element .info-icon {
        color: #fff;
        display: inline-block;
        width: 24px;
        height: 24px;
        text-align: center;
        line-height: 24px;
        margin-left: 8px;
        cursor: help;
      }

      body.dark-mode select {
        background-color: #555;
        color: #f0f0f5;
        border: 1px solid #666;
        border-radius: 8px;
        width: 100%;
      }

      body.dark-mode select option {
        background-color: #666;
        color: #e0e0e0;
      }

      .logo {
        margin-bottom: 20px;
      }

      .logo img {
        max-width: 120px;
        height: auto;
      }

      .name {
        font-size: 2rem;
        color: #333;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .version {
        font-size: 1.2rem;
        color: #888;
      }

      .description {
        font-size: 1rem;
        color: #555;
        margin-bottom: 20px;
      }

      .separator {
        border-top: 1px solid #e0e0e0;
        margin: 20px 0;
      }

      .provider-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
      }

      .provider,
      .selected-provider {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        border: 2px solid #ccc;
        overflow: hidden;
        position: relative;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .provider img,
      .selected-provider img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: filter 0.3s;
      }

      .provider:hover,
      .selected-provider:hover {
        border-color: #333;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .remove-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #d90f0f;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        padding: 0;
        z-index: 1;
      }

      .remove-button:hover {
        background: #a70202;
      }

      .pure-form {
        margin-top: 20px;
      }

      .form-element {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-element label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }

      .form-element input,
      .form-element select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        color: #333;
      }

      .button-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 20px;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
      }

      #installButton {
        background-color: #007aff;
      }

      #installButton:hover {
        background-color: #0051a8;
      }

      #copyButton {
        background-color: #4caf50;
      }

      #copyButton:hover {
        background-color: #388e3c;
      }

      .popup {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px;
        border-radius: 8px;
        color: #fff;
        background-color: #333;
        font-size: 0.9rem;
      }

      .popup.success {
        background-color: #4caf50;
      }

      .popup.error {
        background-color: #f44336;
      }

      @media (max-width: 768px) {
        .provider-container {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 15px;
        }

        .provider {
          width: 100%;
          height: auto;
          padding: 10px;
        }
      }

      .popup {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px;
        border-radius: 8px;
        color: #fff;
        background-color: #333;
        font-size: 0.9rem;
        z-index: 1000;
      }

      .popup.success {
        background-color: #4caf50;
      }

      .popup.error {
        background-color: #f44336;
      }

      .info-icon {
        font-size: 1.2rem;
        color: #007aff;
        cursor: pointer;
        margin-left: 8px;
        vertical-align: middle;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        max-width: 500px;
        width: 90%;
        text-align: left;
      }

      .modal h4 {
        margin-top: 0;
      }

      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 1.2rem;
        color: #333;
      }

      @media only screen and (max-width: 768px) {
        .modal {
          height: 100vh;
          max-height: 80vh;
          margin: 0;
          border: none;
          overflow-y: auto;
        }

        .modal h4 {
          margin-top: 0;
        }

        .modal-close {
          position: absolute;
          top: 10px;
          right: 10px;
          cursor: pointer;
          font-size: 1.5rem;
          color: #333;
        }
      }
    </style>
  </head>
<html>
  <body>
    <div id="addon">
      <div id="theme-toggle" class="theme-toggle" title="Toggle Dark/Light Mode"> ðŸŒ™ </div>
      <div class="logo">
        <img src="assets/logo.png" alt="Addon Logo" />
      </div>
      <h1 class="name">Streaming Catalog Providers</h1>
      <h2 class="version">1.0.0</h2>
      <h2 class="description">Choose your streaming providers below.</h2>
      <div class="separator"></div>
      <h3 class="providers-title">Available providers</h3>
      <div class="form-element">
        <input type="text" id="searchProviders" placeholder="Search providers..." />
      </div>
      <div id="providers" class="provider-container"></div>
      <div class="separator"></div>
      <form class="pure-form" id="mainForm">
        <div class="form-element">
          <label for="tmdbApiKey"> TMDB API key (<a href="https://www.themoviedb.org/settings/api" target="_blank" style="color: #007aff;">Get it here</a>) </label>
          <input type="text" id="tmdbApiKey" name="tmdbApiKey" />
        </div>
        <div class="form-element">
          <label for="language"> Language </label>
          <select id="language" name="language" required>
            <option value="">Select your language</option>
          </select>
        </div>
        <div class="form-element">
          <label for="ageRange"> Age range (content moderation) <span id="infoIcon" class="info-icon" title="Learn more">?</span>
          </label>
          <select id="ageRange" name="ageRange">
            <option value="">Select your age range</option>
            <option value="0-5">0-5 years</option>
            <option value="6-11">6-11 years</option>
            <option value="12-15">12-15 years</option>
            <option value="16-17">16-17 years</option>
            <option value="18+">18+ years</option>
          </select>
        </div>
        <div class="separator"></div>
        <h3 class="selected-providers-title">Selected providers</h3>
        <div id="selectedProviders" class="provider-container"></div>
        <div class="separator"></div>
        <div class="button-container">
          <button type="button" id="installButton">INSTALL</button>
          <button type="button" id="copyButton">COPY LINK</button>
        </div>
        <div class="separator"></div>
      </form>
      <div id="popup" class="popup"></div>
      <div id="infoModal" class="modal">
        <span id="modalClose" class="modal-close">&times;</span>
        <h4>Age Range Content Moderation</h4>
        <p> The content moderation system filters media based on the selected age range to ensure suitability for viewers. Here's how it works: </p>
        <ul>
          <li>
            <strong>0-5 years:</strong> Uses the US certification 'G' (General Audience). Filters out content that is not suitable for very young children. This includes genres such as horror, drama, thriller, crime, war, western, erotic, war & politics, talk-show, soap-opera, reality-show, news, mystery, documentary, and history.
          </li>
          <li>
            <strong>6-11 years:</strong> Uses the US certification 'G' (General Audience). Filters out content unsuitable for young children, maintaining a focus on safe, family-friendly genres. The same genres as for 0-5 years are excluded.
          </li>
          <li>
            <strong>12-15 years:</strong> Uses the US certification 'PG' (Parental Guidance). Allows content with mild themes appropriate for older children and pre-teens. No specific genres are excluded for this age range.
          </li>
          <li>
            <strong>16-17 years:</strong> Uses the US certification 'PG-13' (Parents Strongly Cautioned). Permits content suitable for older teens, including more complex and mature themes but not adult content. No specific genres are excluded for this age range.
          </li>
          <li>
            <strong>18+ years:</strong> Includes all content, even those with adult themes and explicit material. For this age range, no genres are excluded.
          </li>
        </ul>
        <p>
        <p>
          <strong>Warning:</strong> Please note that the data for this content moderation system is sourced from TMDB (The Movie Database) and may contain inaccuracies. Viewer discretion is advised.
        </p>
        </p>
      </div>
      <script src="js/languages.js"></script>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          function populateLanguageDropdown() {
            const dropdown = document.getElementById('language');
            languages.forEach(lang => {
              const option = document.createElement('option');
              option.value = lang.iso_639_1;
              option.textContent = lang.english_name + (lang.name ? ` (${lang.name})` : '');
              dropdown.appendChild(option);
            });
          }
          populateLanguageDropdown();
          const mainForm = document.getElementById('mainForm');
          const installButton = document.getElementById('installButton');
          const copyButton = document.getElementById('copyButton');
          const popup = document.getElementById('popup');
          const providersContainer = document.getElementById('providers');
          const infoIcon = document.getElementById('infoIcon');
          const infoModal = document.getElementById('infoModal');
          const modalClose = document.getElementById('modalClose');
          const selectedProvidersContainer = document.getElementById('selectedProviders');
          let selectedProviders = [];
          let providersMap = {};
          new Sortable(selectedProvidersContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
              selectedProviders = Array.from(selectedProvidersContainer.querySelectorAll('.selected-provider')).map(div => div.getAttribute('data-id'));
            }
          });
          const renderSelectedProviders = () => {
            selectedProvidersContainer.innerHTML = selectedProviders.map(providerId => `
              <div class="selected-provider" data-id="${providerId}">
                <img src="https://image.tmdb.org/t/p/w500/${providersMap[providerId].logo_path}" alt="${providersMap[providerId].display_name}" title="${providersMap[providerId].display_name}" />
                <button class="remove-button" data-id="${providerId}">&times;</button>
              </div>`).join('');
            document.querySelectorAll('.remove-button').forEach(button => {
              button.addEventListener('click', (event) => {
                const providerId = event.target.getAttribute('data-id');
                selectedProviders = selectedProviders.filter(id => id !== providerId);
                const providerElement = document.querySelector(`.provider[data-id="${providerId}"]`);
                if (providerElement) providerElement.style.display = 'block';
                renderSelectedProviders();
              });
            });
          };
          const fetchProviders = async () => {
            try {
              const response = await fetch('/providers');
              if (!response.ok) {
                throw new Error('Failed to fetch providers');
              }
              const providers = await response.json();
              providersMap = providers.reduce((map, provider) => {
                map[provider.id] = provider;
                return map;
              }, {});
              return providers;
            } catch (error) {
              console.error('Error fetching providers:', error);
              return [];
            }
          };
          const renderProviders = async () => {
            const providers = await fetchProviders();
            providers.sort((a, b) => a.display_name.localeCompare(b.display_name));
            providersContainer.innerHTML = providers.map(provider => `
              <div class="provider" data-id="${provider.id}">
                <img src="https://image.tmdb.org/t/p/w500/${provider.logo_path}" alt="${provider.display_name}" title="${provider.display_name}" />
              </div>`).join('');

            document.querySelectorAll('.provider').forEach(provider => {
              provider.addEventListener('click', () => {
                const providerId = provider.getAttribute('data-id');
                if (selectedProviders.includes(providerId)) {
                  selectedProviders = selectedProviders.filter(id => id !== providerId);
                  provider.style.display = 'block';
                } else {
                  selectedProviders.push(providerId);
                  provider.style.display = 'none';
                }
                renderSelectedProviders();
              });
            });
          };
          const showInfoModal = () => {
            infoModal.style.display = 'block';
          };
          const hideInfoModal = () => {
            infoModal.style.display = 'none';
          };
          infoIcon.addEventListener('click', showInfoModal);
          modalClose.addEventListener('click', hideInfoModal);
          const getStremioLink = () => {
            const config = Object.fromEntries(new FormData(mainForm));
            config.providers = selectedProviders;
            config.ageRange = document.getElementById('ageRange').value;
            return "stremio://" + window.location.host + "/" + encodeURIComponent(JSON.stringify(config)) + "/manifest.json";
          };
          const getHttpsLink = () => {
            const config = Object.fromEntries(new FormData(mainForm));
            config.providers = selectedProviders;
            config.ageRange = document.getElementById('ageRange').value;
            return "https://" + window.location.host + "/" + encodeURIComponent(JSON.stringify(config)) + "/manifest.json";
          };
          const showPopup = (message, type) => {
            popup.textContent = message;
            popup.className = `popup ${type}`;
            popup.style.display = 'block';
            setTimeout(() => {
              popup.style.display = 'none';
            }, 3000);
          };
          const validateForm = () => {
            const language = document.getElementById('language').value.trim();
            const ageRange = document.getElementById('ageRange').value.trim();
            return language && ageRange && selectedProviders.length > 0;
          };
          copyButton.onclick = () => {
            if (!validateForm()) {
              showPopup('Configuration incomplete: Please select a Language, an Age Range and choose at least one provider.', 'error');
              return;
            }
            const link = getHttpsLink();
            navigator.clipboard.writeText(link).then(() => {
              showPopup('Link copied to clipboard!', 'success');
            }).catch(err => {
              console.error('Failed to copy the link: ', err);
              showPopup('Failed to copy the link.', 'error');
            });
          };
          installButton.onclick = () => {
            if (!validateForm()) {
              showPopup('Configuration incomplete: Please select a Language, an Age Range and choose at least one provider.', 'error');
              return;
            }
            const link = getStremioLink();
            window.location.href = link;
          };
          renderProviders();
          document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.getElementById('theme-toggle').textContent = isDarkMode ? 'ðŸŒž' : 'ðŸŒ™';
          });
          document.getElementById('searchProviders').addEventListener('input', function(event) {
          const searchTerm = event.target.value.toLowerCase();
          document.querySelectorAll('#providers .provider').forEach(provider => {
            const providerName = providersMap[provider.getAttribute('data-id')].display_name.toLowerCase();
            provider.style.display = providerName.includes(searchTerm) ? 'flex' : 'none';
          });
          });
        });
      </script>
  </body>
</html>